#!/usr/bin/env ruby

require 'uri'
require 'active_record'

if ENV['AUTO_MIGRATE'] == '1'
  pg_uri = URI.parse(ENV['DATABASE_URL'])
  port = pg_uri.port || 5432

  # check that we can connect to Postgres
  connected = false
  60.times do
    begin
      puts "Attempting DB connection at #{pg_uri.host}:#{port} with user #{pg_uri.user}"
      ActiveRecord::Base.establish_connection(ENV['DATABASE_URL'])
      connected = true
      break
    rescue Exception
      sleep(1.second)
    end
  end
  abort("Unable to connect to Postgres host at #{pg_uri.host}:#{port} with user #{pg_uri.user}") unless connected

  # create and migrate DB
  abort('Unable to migrate DB') unless system('bundle exec rails db:create db:migrate')
end

exec('bundle exec puma -C config/puma.rb')
